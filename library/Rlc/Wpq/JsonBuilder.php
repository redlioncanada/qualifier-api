<?php

namespace Rlc\Wpq;

use Rlc\Wpq\FeedEntity;

class JsonBuilder {

  /**
   * @var FeedModelBuilderInterface
   */
  private $feedModelBuilder;

  /**
   * @var array identifier => localized user-facing name
   * 
   * TODO This will actually come from some config generated by the
   * manager control panel where you select categories to include.
   */
  private $applianceGroups = [
    'SC_Kitchen_Cooking' => [
      'en_CA' => 'Cooking',
      'fr_CA' => '',
    ],
    'SC_Laundry_Laundry_Appliances_Laundry_Pairs' => [
      'en_CA' => 'Laundry',
      'fr_CA' => '',
    ],
    'SC_Kitchen_Dishwashers_and_Kitchen_Cleaning_Dishwashers' => [
      'en_CA' => 'Dishwashers',
      'fr_CA' => '',
    ],
    'SC_Kitchen_Refrigeration_Refrigerators' => [
      'en_CA' => 'Fridges',
      'fr_CA' => '',
    ],
  ];

  /**
   * See above comment
   */
  private $typeGroups = [
    'SC_Kitchen_Cooking_Ranges' => [
      'en_CA' => 'Ranges',
      'fr_CA' => '',
    ],
    'SC_Kitchen_Cooking_Wall_Ovens' => [
      'en_CA' => 'Ovens',
      'fr_CA' => '',
    ],
  ];

  public function __construct(FeedModelBuilderInterface $feedModelBuilder) {
    $this->feedModelBuilder = $feedModelBuilder;
  }

  /**
   * 
   * @param string $brand
   * @return string JSON
   */
  public function build($brand, $locale) {
    $topLevelEntries = $this->feedModelBuilder->buildFeedModel($brand);

    $getGroupId = function ($group) {
      return (string) $group->identifier;
    };

    // Filter for target group - dev only to speed up testing
    foreach ($topLevelEntries as $key => $entry) {
      $allCatalogGroups = $entry->getAllCatalogGroups();
      $allCatalogGroupIds = array_map($getGroupId, $allCatalogGroups);
      // If none of the groups is one of the target groups
      if (!count(array_intersect(array_keys($this->applianceGroups), $allCatalogGroupIds))) {
        unset($topLevelEntries[$key]);
      }
    }

    /*
     * From here on is code that could actually be used for production,
     * not just for testing...
     */

    $outputData = [];
    foreach ($topLevelEntries as $entry) {
      $newOutputData = [
        'sku' => (string) $entry->partnumber,
      ];

      $this->attachGroupData($newOutputData, $entry, $locale);
      $this->attachCatalogEntryDescriptionData($newOutputData, $entry, $locale);

      $childEntries = $entry->getChildEntries();
      foreach ($childEntries as $childEntry) {
        $this->attachChildEntryData($newOutputData, $childEntry, $locale);
      }

      $outputData[] = $newOutputData;
    }
//    
    // Just testing output
//    ini_set('xdebug.var_display_max_depth', 5);
//    var_dump($catalogEntries['MEW6527DDQ']->getParentEntry());
//    die;

    $json = json_encode($outputData, JSON_PRETTY_PRINT);
//    die($json);
    return $json;
  }

  private function attachGroupData(array &$data, FeedEntity\CatalogEntry $entry,
      $locale) {
    $allCatalogGroups = $entry->getAllCatalogGroups();
    foreach ($allCatalogGroups as $catalogGroup) {
      $groupId = (string) $catalogGroup->identifier;
      if (isset($this->applianceGroups[$groupId])) {
        $data['appliance'] = $this->applianceGroups[$groupId][$locale];
      }
      if (isset($this->typeGroups[$groupId])) {
        $data['type'] = $this->typeGroups[$groupId][$locale];
      }
    }
  }

  private function attachChildEntryData(array &$data,
      FeedEntity\CatalogEntry $childEntry, $locale) {
    $variantPartNumber = (string) $childEntry->partnumber;

    $colourDa = $childEntry->getDefiningAttributeValue('Color');
    $newColoursElem = [
      'sku' => $variantPartNumber,
      'colourCode' => (string) $colourDa->valueidentifier,
    ];
    $newColoursElem['colourName'] = (string) $colourDa->getRecord($locale)->value;

    /*
     * Attach price info
     */
    $prices = $childEntry->getPrices();
    $curDate = new \DateTime();
    foreach ($prices as $price) {
      // TODO published=0 or price=0 should exclude the whole product,
      // not only the price data. not sure about being out of date range,
      // need to find that out.

      if (// conditions to exclude:
          ('1' != $price->published) // ... not published
          // ... price is zero
          || (0 == (float) $price->listprice && 0 == (float) $price->saleprice)
      ) {
        continue;
      }
      // we're not in the date range
      $startDate = new \DateTime((string) $price->startdate);
      $endDate = new \DateTime((string) $price->enddate);
      if (($startDate > $curDate) || ($endDate < $curDate)) {
        continue;
      }

      $newColoursElem['prices'][] = [
        'currency' => (string) $price->currency,
        'list' => (string) $price->listprice,
        'sale' => (string) $price->saleprice,
      ];
    }

    $data['colours'][] = $newColoursElem;
  }

  private function attachCatalogEntryDescriptionData(array &$data,
      FeedEntity\CatalogEntry $entry, $locale) {
    $description = $entry->getDescription();
    $localeRecord = $description->getRecord($locale);
    $data['name'] = (string) $localeRecord->name;
    $data['description'] = (string) $localeRecord->londescription;
  }

}
